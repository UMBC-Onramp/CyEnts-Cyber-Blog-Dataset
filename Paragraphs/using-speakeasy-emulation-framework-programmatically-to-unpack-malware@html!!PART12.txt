
Based on prior analysis, weâ€™re looking for a VirtualAlloc call that receives the lpAddress value 0 and the flProtect value PAGE_EXECUTE_READWRITE ( 0x40 ).
If these arguments are present, the virtual address and specified size are stored on lines 15 and 16 so they may be used to extract the unpacked payload from memory after the unpacking code is finished.
Finally, on line 17, the return value from the VirtualAlloc handler is returned by the hook.
Surgical Code Emulation Using API and Code Hooks Speakeasy is a robust emulation framework; however, you may encounter binaries that have large sections of problematic code.
For example, a sample may call many unsupported APIs or simply take far too long to emulate.
An example of overcoming both challenges is described in the following scenario.
Unpacking Stubs Hiding in MFC Projects A popular technique used to disguise malicious payloads involves hiding them inside a large, open-source MFC project.
MFC is short for Microsoft Foundation Class , which is a popular library used to build Windows desktop applications.